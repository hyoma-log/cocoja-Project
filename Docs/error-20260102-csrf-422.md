# エラー解決報告: 422 Error (The change you wanted was rejected)

## 元のエラーメッセージまたは問題の概要
新規登録など、フォーム送信時に `422 Unprocessable Entity` ("The change you wanted was rejected") が発生しました。
ログや状況から、CSRFトークンの検証失敗（`ActionController::InvalidAuthenticityToken`）が原因と特定されました。

## 原因の分析（根本原因）
`config/environments/production.rb` に以下の設定が存在しました。

```ruby
config.action_dispatch.trusted_proxies = %w[127.0.0.1 ::1].map { |proxy| IPAddr.new(proxy) }
```

この設定は、Railsが「信頼するプロキシサーバー（ロードバランサー）」を **localhost (127.0.0.1)** のみに制限するものです。
本番環境（クラウド/コンテナ）では、外部のロードバランサー経由でアクセスが来るため、Railsはそのリクエストのヘッダー（`X-Forwarded-Proto` 等）を信頼せず、無視しました。
その結果、実際のアクセスは `https` であるにもかかわらず、Railsは `http` と誤認し、CSRFトークンのオリジンチェックで不整合が生じてエラーとなりました。

## 実行した解決手順
`config/environments/production.rb` の当該設定行をコメントアウトしました。
これにより、Railsはデフォルト（またはプラットフォーム標準）の挙動となり、上位のロードバランサーからのヘッダー情報を正しく解釈できるようになります。

## 解決後の検証結果（成功の証拠）
（コード修正のみのため、本番デプロイ後にユーザーによる登録成功をもって最終確認とします）
理論上、SSL終端プロキシ配下での典型的な設定ミスであり、この制限解除により `request.ssl?` が `true` を返すようになり、CSRFチェックが通過します。
